#summary Configuring Mod_Auth_External

There are three parts to doing the configuration.  First, if you are using
dynamic loading, you need to configure Apache to load the `mod_authnz_external`
module.  If '`apxs`' is working correctly, it should do this for you
automatically, but it doesn't always.

Second you define the external program and communication method to use in
your `httpd.conf` file, identifying them with a keyword.

Finally you set up specific directories to use that authenticator, referencing
it by keyword.

These instructions talk about editing the "`httpd.conf`" file, as it appears in
the standard Apache distributions.  In many version of Linux, however, this
file will actually just include a lot of other configuration files, some of
which may be automatically generated by various GUI configuration tools.  I
include notes on some of these variations that I have encountered, but you
may need to do some of your own figuring to find out how to adapt these
instructions to your server configuration.

== 1.  Getting the Module Loaded ==

This step is not required if you are using static loading.  Even if you are doing dynamic loading, `apxs` should have set up everything correctly for you.  If you are trustful, you can skip ahead to step 2 and only come back to this if things don't seem to be working.  In cases where you are using multiple non-authoritative authenticators you'll probably want to check this manually, even if apxs works right, to ensure that the modules are loaded (and thus envoked) in the desired order.

<ol>
<li>First, you should make sure that there is a proper "`LoadModule`" command in the httpd.conf file.  This should have been put there by '`apxs`' but, some older Linux distributions, like Redhat 6.1, messed it up.  Basically, the 'LoadModule' command should look a lot like all the other LoadModule commands you'll find there.  Something like
{{{
LoadModule authnz_external_module modules/mod_authnz_external.so
}}}
where the second part is the path from Apache's root directory to the location where the module was stored by `apxs`.

Make sure that apxs didn't put this directive inside any inappropriate `<IfDefine>` directives, as some Redhat versions have done in the past.

If you previously had `mod_authnz_external` or `mod_auth_external` installed and are installing a new version, you may have more than one `LoadModule` command in `httpd.conf`.  You only need one.  Get rid of the old ones.
</li>
<li>Check you `httpd.conf` file to see if there is a "`ClearModuleList`" command.  If this exists, then you need to add a command like:
{{{
AddModule mod_authnz_external.c
}}}
somewhere below "ClearModuleList" command (probably somewhere among dozens of other AddModule commands).  If you used 'apxs' to install mod_authnz_external, then this should already be done, but it may again be stashed in an inappropriate `<IfDefine>`.

The standard Apache configuration files don't have a "`ClearModuleList`" command and don't need an "`AddModule`" command.  However the standard Redhat configuration files, among others, do.
</li>
</ol>

== 2.  Configuring the External Authenticator ==

In this section we insert commands into `httpd.conf` that will be run when Apache starts up to tell Apache where your external authenticators are and how to communicate with them.

It is possible to configure several different external authenticators into Apache.  For each one you need to configure a name, a method of communicating with authenticator, and the location of the authenticator.

The structure of Apache `httpd.conf` differs widely on different systems. The notes below on where to put configuration commands assume that you have something close to a straight apache install, but you probably don't.  Very likely there will be comments in your `httpd.conf` file that tell you where to put local configuration commands.

If you are using virtual hosts, put these commands at the end of the appropriate `<VirtualHost>` block.  The declarations must be _inside_ the `<VirtualHost>` block to work for a virtual host.  They are not inherited from the primary host to the virtual hosts.  Note that most Apache SSL servers are set up as virtual hosts, so you'll probably  need to put these definitions in the `<VirtualHost>` block for use with an SSL server.

Otherwise, just put them anywhere (just before the Virtual Hosts section of the standard Apache config file might make the most sense).

Two different command syntaxes are supported in mod_authnz_external. One that is compatible with releases before 3.2.0, and one that is a bit more compact, using one command instead of two.  

=== 2.1. External Password Authenticators ===

New-Style Syntax:
{{{
DefineExternalAuth <keyword> <method> <location>
}}}

Old-Style Syntax:
{{{
AddExternalAuth <keyword> <location>
SetExternalAuthMethod <keyword> <method>
}}}

`<keyword>` is some name you choose to identify the authenticator.  You can configure multiple different external authenticators by using different keywords for them.

`<method>` defines how the login and password are passed to the external authenticator.  The possible values are:
|| `pipe` || read newline-terminated strings from stdin.  (default) ||
|| `environment` || get args from environment variables. ||
|| `checkpassword` || read null-terminated strings from file descriptor 3. ||
|| `function` || internal authenticator called as function. ||

'Pipe' is the default.  `Environment` used to be the default in  versions of `mod_auth_external` before 3.1.0, but is insecure on some versions of Unix.

`<location>` tells where to find the authenticator.  It's syntax varies somewhat by method (which is why we introduced the new syntax - to keep it closer to the method declaration):

 * *For "pipe", "environment", and "checkpassword" methods:* `<location>` is the full path where you installed your external authentication program, like "`/usr/local/bin/auth_check`". It always starts with a slash.  If you put it in quotes, you can include command-line arguments, but these arguments won't be processed by a shell, so you can't use wildcards or I/O redirects or anything like that.  (If you need shell processing of arguments, write an sh-script wrapper for your authenticator, and put the path to that here.)

 * *For the "function" method:* `<location>` is a string like "`<type>:<data>`".  The `<type>` part is a string that can be used to select from multiple internal functions.  `<data>` is a string passed to that function and is typically used as config file path.  The "`:`" is required even if the `<data>` is an empty string.

In the old-style syntax, the path declaration should always preceed the method declaration, and the method declaration can be omitted if you want the default.

Here are some examples.  We give old-style syntax only for the first example, but it can be used in all cases:

_For external authentication programs using a pipe:_
{{{
DefineExternalAuth archive_auth pipe /usr/local/bin/authcheck
}}}
-or-
{{{
AddExternalAuth archive_auth /usr/local/bin/authcheck
SetExternalAuthMethod archive_auth pipe
}}}

_For external authentication programs using a pipe:_
{{{
DefineExternalAuth archive_auth environment /usr/local/bin/authcheck
}}}

_For external authenticators using the checkpassword protocol:_
{{{
DefineExternalAuth archive_auth checkpassword "/bin/checkpassword /bin/true"
}}}

_For HARDCODE functions with a configuration file:_
{{{
DefineExternalAuth archive_auth function RADIUS:/usr/local/raddb
}}}

_For HARDCODE functions with no configuration file:_
{{{
DefineExternalAuth function archive_auth RADIUS:
}}}

=== 2.2. External Group Checkers ===

If you want to use an external program to do group checking, add one of the following to your server's `httpd.conf`:

New-Style Syntax:
{{{
DefineExternalGroup <keyword> <method> <location>
}}}

Old-Style Syntax:
{{{
AddExternalGroup <keyword> <location>
SetExternalGroupMethod <keyword> <method>
}}}

`<keyword>` is some name you choose to identify this particular group checking method.  The keywords for login authenticators and group authenticators are separate name spaces, so it doesn't matter if these keywords match any you defined with `DefineExternalAuth` or `AddExternalAuth`.

`<method>` defines how the login and group names are passed to the external authenticator.  Legal values are:

|| pipe || authenticator reads data from standard input. ||
|| environment || authenticator gets data from environment variables. ||

`Pipe` is the default.  `Environment` used to be the default before version 3.1.0. The "`checkpassword`" keyword also works, but doesn't really make a lot of sense since there are no checkpassword authenticators for groups.

Examples:

_For external group checking programs using a pipe:_
{{{
DefineExternalGroup archive_group pipe /usr/local/bin/grpcheck
}}}
-or-
{{{
AddExternalGroup archive_group /usr/local/bin/grpcheck
SetExternalGroupMethod archive_group pipe
}}}

_For external group check programs using environment variables:_
{{{
DefineExternalGroup archive_group environment /usr/local/bin/grpcheck
}}}

== 3. Configuring Web Pages to Use Authentication ==
*THIS PAGE IS INCOMPLETE *